<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="lib/jQueryEvents.js"></script>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/master.css">
    <link rel="stylesheet" href="css/laptop.css">
    <link rel="stylesheet" href="css/fa.css">
    <title></title>
  </head>
  <body>
    <div id='transparent'>

    </div>
    <header>
      <img id='logo' src='img/Logomakr_8p5QjD.png' />
      <ul id='icon-list'>
        <a href='https://www.linkedin.com/in/john-van-schultz-422623a4/' target="_blank"><li><i class="fa fa-linkedin" aria-hidden="true"></i></li></a>
        <a href='https://github.com/jvansch1' target="_blank"><li><i class="fa fa-github" aria-hidden="true"></i></li></a>
        <a href='http://johnvanschultz.site' target="_blank"><li><i class="fa fa-user-circle-o" aria-hidden="true"></i></li></a>
        <a href='https://s3.amazonaws.com/untappd-dev/nnResume.pdf' target="_blank"><li><i class="fa fa-file-pdf-o" aria-hidden="true"></i></li></a>
      </ul>
    </header>
    <div id='shadow'></div>
    <div id='container'>
      <div id='ask-bid'>
        <div id='count'>
          <p id='bids'><span class='ask-bid-title'>Bids:</span> </p>
          <p id='asks'><span class='ask-bid-title'>Asks:</span> </p>
        </div>
        <div id='chart-container'>
        </div>
      </div>
      <div id='right'>
        <div id='trade-info'>
          <div class='trade-result-container'><p id='time'><span class='ask-bid-title'>Time: </span></p></div>
          <div class='trade-result-container'><p id='price'><span class='ask-bid-title'>Price: </span></p></div>
          <div class='trade-result-container'><p id='shares'><span class='ask-bid-title'>Shares: </span></p></div>
          <div class='trade-result-container'><p id='trade-type'><span class='ask-bid-title'>Trade Type: </span></p></div>
          <div class='trade-result-container'><p id='reference'><span class='ask-bid-title'>Reference #: </span></p></div>
        </div>
        <div id='button-container'>
          <p>Trade Size</p>
          <input id='scale-slider' type='range' value='1' min='1' max='2' step='.01'></input>
          <p>Controls</p>
          <button id='toggle-trades'>Toggle Trades</button>
          <button id='toggle-e'>Toggle E</button>
          <button id='toggle-p'>Toggle P</button>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Activate events from jQuery file
        Events()

        $.ajax({
          type: 'GET',
          url: 'https://api.myjson.com/bins/1gjv1x',
          success: (returnData) => {
            let data;
            let height;
            let width;
            if (window.innerWidth < 1300) {
              width = 650;
              height = 450;
            } else {
              height = 600;
              width = 1000;
            }
            data = returnData
            let tradeScale = 1;
            let dates = [];


            asks = data.bboList.map(obj => {
              return obj.ask
            })
            bids = data.bboList.map(obj => {
              return obj.bid
            })
            times = data.bboList.map(obj => {
              newString = obj.timeStr.split('').filter(char => {
                return (char != ":" && char != ".")
              })
              parsedString = newString.join('')
              let hours = parseInt(parsedString.slice(0,2))
              let hoursInNanoSeconds = hours * 60 * 60 * 1000000000
              let minutes = parseInt(parsedString.slice(2,4))
              let minutesInNanoSeconds = minutes * 60 * 1000000000
              let seconds = parseInt(parsedString.slice(4,6))
              let secondsInNanoSeconds = seconds * 1000000000
              let milliseconds = parseInt(parsedString.slice(6))
              let millisecondsInNanoSeconds = milliseconds * 1000000
              let total = hoursInNanoSeconds + minutesInNanoSeconds + secondsInNanoSeconds + millisecondsInNanoSeconds
              let date = new Date(total / 1000000)
              date.setHours(date.getHours() + 5)
              dates.push(date)
              return total
            })
            // console.log(times)

            let margins = {
              bottom: 40,
              top: 20,
              left: 80,
              right: 20
            }

            width = width - margins.left - margins.right
            height = height - margins.top - margins.bottom

            maxYRange = d3.max(data.bboList, function(d, i) {
              return d.bid
            })
            minYRange = d3.min(data.bboList, function(d, i) {
              return d.bid
            })

            let x = d3.scaleLinear()
              .domain([times[0], times[times.length - 1]])
              .range([0, width])

            let y = d3.scaleLinear()
              .domain([minYRange, 240000])
              .range([height, 0])

            let xTimeScale = d3.scaleTime()
              .domain([dates[0], dates[dates.length - 1]])
              .range([0,width])

            let svg = d3.select("#chart-container")
              .append("svg")
              .classed("chart", true)

            let asksArea = d3.area()
              .curve(d3.curveStepAfter)
              .x(function(d,i) { return x(times[i])})
              .y0(0)
              .y1(function(d,i) {return y(d)})

            let bidsArea = d3.area()
              .curve(d3.curveStepAfter)
              .x(function(d,i) { return x(times[i])})
              .y0(height)
              .y1(function(d,i) {return y(d)})

            // function zoomed() {
            //   chart.attr("transform", d3.event.transform)
            // }
            //
            // let zoom = d3.zoom()
            //   .scaleExtent([1,8])
            //   .on("zoom", zoomed)

            let chart = svg.append("g")
              .classed("display", true)
              .data(data.bboList)
              .attr("transform", `translate(${margins.left},${margins.top})`)
              .on("mousemove", function(d) {
                let rounded = Math.floor(x.invert(d3.event.pageX)).toString().split('').slice(0,8)
                rounded = rounded.join('') + "000000";
                let index = null;
                times.forEach((val,idx) => {
                  // console.log(rounded)
                  if (val > rounded - 8000000000000 && index === null) {
                    index = idx
                  }
                })
                // console.log(x.invert(d3.event.pageX))
                // console.log(index)
                if (index === null) {
                  $("#bids").html("<span class='ask-bid-title'>Bids:</span>" + `<span class='ask-bid-result'>${bids[bids.length - 1]}</span>`)
                  $("#asks").html("<span class='ask-bid-title'>Asks:</span>" + `<span class='ask-bid-result'>${asks[asks.length - 1]}</span>`)
                } else {
                  $("#bids").html("<span class='ask-bid-title'>Bids:</span>" + `<span class='ask-bid-result'>${bids[index]}</span>`)
                  $("#asks").html("<span class='ask-bid-title'>Asks:</span>" + `<span class='ask-bid-result'>${asks[index]}</span>`)
                }
              })
              // .call(zoom)

            // Add Area to chart
            chart.append("path")
              // .data(asks)
              .classed("area", true)
              .attr("d", asksArea(asks))

            chart.append("path")
              // .data(asks)
              .classed("area2", true)
              .attr("d", bidsArea(bids))

            function Hours(hour) {
              if (hour > 12) {
                return hour - 12
              }

              return hour
            }

            function Minutes(minutes) {
              if (minutes < 10) {
                return `0${minutes}`
              }
              return `${minutes}`
            }

            chart.selectAll(".trades")
              .data(data.tradeList)
            .enter()
            .append("circle")
            .classed("trades", function(d) {
              if (d.tradeType === "E") {
                return d3.select(this).classed("E", true)
              } else if (d.tradeType === "P") {
                return d3.select(this).classed("P", true)
              }
            })
            .attr("fill", function(d) {
              if (d.tradeType === "E") {
                return "red"
              } else if (d.tradeType === "P") {
                return "blue"
              }
            })
            .attr("r", function(d) {
              return d.shares / 50 * $('#scale-slider').val()
            })
            .attr("cx", function(d, i) {
              return x(d.time)
            })
            .attr("cy", function(d,i){
              return y(d.price)
            })
            .attr("data", function(d,i) {
              return d.shares
            })
            .on("mouseover", function(d) {
              console.log(d)
              $("#time").html("<div class='trade-result-container'><span class='ask-bid-title'>Time:</span>" + " " +  "<span class='trade-results'>" + Hours((new Date(d.time / 1000000).getHours() + 5)) + ":" + Minutes(new Date(d.time / 1000000).getMinutes()) +  "</span></div>")
              $("#price").html("<div class='trade-result-container'><span class='ask-bid-title'>Price:</span>" + " " +  "<span class='trade-results'>" + d.price + "</span></div>")
              $("#shares").html("<div class='trade-result-container'><span class='ask-bid-title'>Shares:</span>" + " " +  "<span class='trade-results'>" + d.shares + "</span></div>")
              $("#trade-type").html("<div class='trade-result-container'><span class='ask-bid-title'>Trade Type:</span>" + " " +  "<span class='trade-results'>" + d.tradeType + "</span></div>")
              $("#reference").html("<div class='trade-result-container'><span class='ask-bid-title'>Reference #:</span>" + " " +  "<span class='trade-results'>" + d.orderReferenceNumber + "</span></div>")
            })

            // Create axis
            let xAxis = d3.axisBottom(x)
            let xTimeAxis = d3.axisBottom(xTimeScale)
            let yAxis = d3.axisLeft(y)

            // Add X axis
            // chart.append("g")
            //   .classed("x axis", true)
            //   .attr("transform", `translate(0,${height})`)
            //   .call(xAxis)

            chart.append("g")
              .classed("x axis", true)
              .attr("transform", `translate(0,${height})`)
              .call(xTimeAxis)

            //Add Y Axis
            chart.append("g")
              .classed("y axis", true)
              .attr("transform", `translate(0,0)`)
              .call(yAxis)

            chart.append("text")
              .attr("class", "x-label")
              .attr("text-anchor", "middle")
              .attr("x", width / 2)
              .attr("y", height + 32)
              .text("Time");

            svg.append("text")
              .attr("class", "y-label")
              .attr("text-anchor", "end")
              .attr("y", 6)
              .attr("x", -200)
              // .attr("x", height / 2)
              .attr("dy", ".75em")
              .attr("transform", "rotate(-90)")
              .text("Price");
          }
        })
      })
    </script>
  </body>
</html>
