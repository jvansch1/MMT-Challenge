<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/master.css">
    <title></title>
  </head>
  <body>
    <script>
      document.addEventListener("DOMContentLoaded", () => {

        $.ajax({
          type: 'GET',
          url: 'https://api.myjson.com/bins/1gjv1x',
          success: (returnData) => {
            let data;
            let height = 800;
            let width = 1200;
            data = returnData
            console.log(data)
            asks = data.bboList.map(obj => {
              return obj.ask
            })
            bids = data.bboList.map(obj => {
              return obj.bid
            })
            times = data.bboList.map(obj => {
              newString = obj.timeStr.split('').filter(char => {
                return (char != ":" && char != ".")
              })
              parsedString = newString.join('')
              let hours = parseInt(parsedString.slice(0,2))
              let hoursInNanoSeconds = hours * 60 * 60 * 1000000000
              let minutes = parseInt(parsedString.slice(2,4))
              let minutesInNanoSeconds = minutes * 60 * 1000000000
              let seconds = parseInt(parsedString.slice(4,6))
              let secondsInNanoSeconds = seconds * 1000000000
              let milliseconds = parseInt(parsedString.slice(6))
              let millisecondsInNanoSeconds = milliseconds * 1000000
              let total = hoursInNanoSeconds + minutesInNanoSeconds + secondsInNanoSeconds + millisecondsInNanoSeconds
              return total
            })

            let tickTimes = [9,10,11,12,1,2,3,4,5,6]



            console.log(times)

            let margins = {
              bottom: 20,
              top: 5,
              left: 80,
              right: 5
            }

            width = width - margins.left - margins.right
            height = height - margins.top - margins.bottom

            maxYRange = d3.max(data.bboList, function(d, i) {
              return d.bid
            })
            minYRange = d3.min(data.bboList, function(d, i) {
              return d.bid
            })

            let x = d3.scaleLinear()
              .domain([times[0], times[times.length - 1]])
              .rangeRound([0, width])

            let y = d3.scaleLinear()
              .domain([minYRange, 240000])
              .rangeRound([height, 0])

            let svg = d3.select("body")
              .append("svg")
              .classed("chart", true)

            let chart = svg.append("g")
              .classed("display", true)
              .attr("transform", `translate(${margins.left},${margins.top})`)
              .on("mousemove", function(d) {
                let coordinates = [0,0]
                coordinates = d3.mouse(this)
                let rounded = Math.floor(x.invert(d3.event.pageX)).toString().split('').slice(0,8)
                rounded = rounded.join('') + "000000";
                let index = null;
                times.forEach((val,idx) => {
                  if (val > rounded && index === null) {
                    index = idx
                  }
                })
                $("#bids").html(bids[index])
                $("#asks").html(asks[index])
              })

            let asksArea = d3.area()
              .x(function(d,i) { return x(times[i])})
              .y0(0)
              .y1(function(d,i) {return y(d)})


            let bidsArea = d3.area()
              .x(function(d,i) { return x(times[i])})
              .y0(height)
              .y1(function(d,i) {return y(d)})

            // Add Area to chart
            chart.append("path")
              // .data(asks)
              .classed("area", true)
              .attr("d", asksArea(asks))

            chart.append("path")
              // .data(asks)
              .classed("area2", true)
              .attr("d", bidsArea(bids))

            chart.selectAll(".trades")
              .data(data.tradeList)
            .enter()
            .append("circle")
            .classed("trades", true)
            .attr("r", 1)
            .attr("cx", function(d, i) {
              return x(d.time)
            })
            .attr("cy", function(d,i){
              return y(d.price)
            })

            // Create axis
            let xAxis = d3.axisBottom(x)
            let yAxis = d3.axisLeft(y)

            // Add X axis
            chart.append("g")
              .classed("x axis", true)
              .attr("transform", `translate(0,${height})`)
              .call(xAxis)

            //Add Y Axis
            chart.append("g")
              .classed("y axis", true)
              .attr("transform", `translate(0,0)`)
              .call(yAxis)

          }
        })
      })
    </script>
    <p id='bids'></p>
    <p id='asks'></p>
  </body>
</html>
